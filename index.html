<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cen Nieruchomości w Polsce</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; background: #f4f4f4; }
        .info {
            padding: 10px; background: white; background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; line-height: 24px;
        }
        .info h4 { margin: 0 0 5px; color: #777; }
        .legend { line-height: 18px; color: #555; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        #controls { position: absolute; top: 10px; left: 50px; z-index: 1000; }
        button { padding: 10px; cursor: pointer; background: white; border: 1px solid #ccc; font-weight: bold; }
    </style>
</head>
<body>

<div id="controls">
    <button onclick="resetMap()">Powrót do Polski (Województwa)</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([52.0, 19.0], 6);
    let geojsonLayer;
    let currentLevel = 'voivodeship'; // voivodeship, county, commune

    // Konfiguracja kolorów w zależności od ceny (zł/m2)
    function getColor(d) {
        return d > 12000 ? '#800026' :
               d > 10000 ? '#BD0026' :
               d > 8000  ? '#E31A1C' :
               d > 7000  ? '#FC4E2A' :
               d > 6000  ? '#FD8D3C' :
               d > 5000  ? '#FEB24C' :
               d > 4000  ? '#FED976' :
                           '#FFEDA0';
    }

    // Funkcja symulująca dane cenowe (tutaj należy podpiąć realne dane)
    function getPriceData(name, code) {
        // Symulacja: Warszawa i duże miasta mają wyższe ceny
        let base = 5000;
        if (code && code.startsWith('14')) base += 4000; // Mazowieckie
        if (code && code.length > 2) base += Math.random() * 2000; 
        return Math.floor(base + (name.length * 100));
    }

    // Styl mapy
    function style(feature) {
        const price = getPriceData(feature.properties.nazwa, feature.properties.kod);
        return {
            fillColor: getColor(price),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
        };
    }

    // Interakcja: Hover i Kliknięcie
    function onEachFeature(feature, layer) {
        const price = getPriceData(feature.properties.nazwa, feature.properties.kod);
        layer.bindPopup(`<strong>${feature.properties.nazwa}</strong><br>Średnia cena: ${price} zł/m²`);
        
        layer.on({
            mouseover: (e) => { e.target.setStyle({ fillOpacity: 0.9, weight: 3 }); },
            mouseout: (e) => { geojsonLayer.resetStyle(e.target); },
            click: (e) => {
                const code = feature.properties.kod;
                if (currentLevel === 'voivodeship') {
                    loadLayer('county', code);
                } else if (currentLevel === 'county') {
                    loadLayer('commune', code);
                }
                map.fitBounds(e.target.getBounds());
            }
        });
    }

    // Ładowanie warstw GeoJSON
    async function loadLayer(level, filterCode = '') {
        if (geojsonLayer) map.removeLayer(geojsonLayer);
        currentLevel = level;

        // Adresy do repozytorium z GeoJSONami Polski (uproszczone)
        const urls = {
            voivodeship: 'https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/wojewodztwa/wojewodztwa-medium.geojson',
            county: 'https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/powiaty/powiaty-medium.geojson',
            commune: 'https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/gminy/gminy-medium.geojson'
        };

        try {
            const response = await fetch(urls[level]);
            let data = await response.json();

            // Filtrowanie (jeśli kliknęliśmy województwo, pokaż tylko jego powiaty)
            if (filterCode) {
                data.features = data.features.filter(f => f.properties.kod.startsWith(filterCode));
            }

            geojsonLayer = L.geoJson(data, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
        } catch (err) {
            console.error("Błąd ładowania mapy:", err);
            alert("Nie udało się pobrać danych mapy.");
        }
    }

    function resetMap() {
        map.setView([52.0, 19.0], 6);
        loadLayer('voivodeship');
    }

    // Legenda
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 4000, 5000, 6000, 7000, 8000, 10000, 12000];
        div.innerHTML = '<h4>Cena m²</h4>';
        for (let i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }
        return div;
    };
    legend.addTo(map);

    // Inicjalizacja
    loadLayer('voivodeship');

</script>
</body>
</html>
