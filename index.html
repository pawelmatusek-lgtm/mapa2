<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Polski - Dynamiczny Drilldown</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; background: #aad3df; }
        .controls { position: absolute; top: 10px; left: 50px; z-index: 1000; }
        button { padding: 10px; cursor: pointer; background: white; border: 1px solid #999; border-radius: 4px; font-weight: bold; }
        .info { padding: 10px; background: rgba(255,255,255,0.9); border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        #loader { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; background: orange; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader">Ładowanie danych z Geoportalu...</div>
<div id="controls" class="controls">
    <button onclick="resetMap()">Powrót do Polski</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([52.0, 19.1], 6);
    let layerGroup = L.featureGroup().addTo(map);
    let currentLevel = 'voivodeship'; // voivodeship -> county -> commune

    // Dodanie podkładu mapowego (jasne tło)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    // Funkcja generująca kolor na podstawie "ceny" (tutaj losowa dla przykładu)
    function getColor(d) {
        return d > 8000 ? '#800026' : d > 6000 ? '#BD0026' : d > 5000 ? '#E31A1C' : 
               d > 4000 ? '#FC4E2A' : d > 3000 ? '#FD8D3C' : '#FEB24C';
    }

    // --- LOGIKA POBIERANIA DANYCH ---

    // 1. Województwa i Powiaty ładujemy z małych plików (są lekkie)
    async function loadStaticLayer(level, parentCode = '') {
        showLoader(true);
        const urls = {
            voivodeship: 'https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/wojewodztwa/wojewodztwa-low.geojson',
            county: 'https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/powiaty/powiaty-low.geojson'
        };

        const res = await fetch(urls[level]);
        let data = await res.json();

        if (parentCode) {
            data.features = data.features.filter(f => f.properties.kod.startsWith(parentCode));
        }

        displayData(data, level);
        showLoader(false);
    }

    // 2. Gminy ładujemy DYNAMICZNIE z serwerów rządowych (WFS) - tylko dla wybranego powiatu!
    async function loadCommunesFromGeoportal(countyCode) {
        showLoader(true);
        
        // Budujemy zapytanie WFS do Geoportalu (filtr po kodzie TERYT)
        // Wykorzystujemy cql_filter, aby pobrać tylko gminy zaczynające się od kodu powiatu
        const wfsUrl = "https://mapy.geoportal.gov.pl/wss/service/PZGIK/PRG/WFS/AdministrativeBoundaries?service=WFS&version=2.0.0&request=GetFeature&typeNames=A03_Granice_gmin&outputFormat=application/json&cql_filter=text%20like%20'"+countyCode+"%'";

        try {
            const res = await fetch(wfsUrl);
            const data = await res.json();
            displayData(data, 'commune');
        } catch (e) {
            alert("Błąd pobierania danych z Geoportalu. Spróbuj ponownie.");
        }
        showLoader(false);
    }

    // --- WYŚWIETLANIE ---

    function displayData(data, level) {
        layerGroup.clearLayers();
        currentLevel = level;

        const geojson = L.geoJson(data, {
            style: () => ({
                fillColor: getColor(Math.floor(Math.random() * 9000)), // Tu wstawisz realne ceny
                weight: 1, color: 'white', fillOpacity: 0.7
            }),
            onEachFeature: (feature, layer) => {
                const props = feature.properties;
                const name = props.nazwa || props.JPT_NAZWA_E || "Brak nazwy";
                const code = props.kod || props.JPT_KOD_JE || "";

                layer.bindPopup(`<b>${name}</b><br>Kod: ${code}`);

                layer.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    if (level === 'voivodeship') {
                        loadStaticLayer('county', code);
                    } else if (level === 'county') {
                        loadCommunesFromGeoportal(code);
                    }
                    map.fitBounds(e.target.getBounds());
                });
            }
        }).addTo(layerGroup);

        if (level !== 'voivodeship') {
            map.fitBounds(geojson.getBounds());
        }
    }

    function resetMap() {
        map.setView([52.0, 19.1], 6);
        loadStaticLayer('voivodeship');
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
    }

    // Start
    loadStaticLayer('voivodeship');

</script>
</body>
</html>
