<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Cen Nieruchomości - Polska 2025</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; }
        #map { height: 100vh; width: 100%; }
        
        .panel {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 280px;
        }

        .price-tag { font-size: 26px; font-weight: bold; color: #c0392b; margin: 10px 0; }
        .unit { font-size: 14px; color: #7f8c8d; font-weight: normal; }

        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .legend { background: white; padding: 10px; border-radius: 8px; line-height: 1.5; font-size: 12px; margin-top: 10px; border: 1px solid #ddd; }
        .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: 0.8; border-radius: 2px; }
        
        #back-btn {
            display: none; width: 100%; margin-top: 15px; padding: 10px;
            background: #2c3e50; color: white; border: none; border-radius: 6px;
            cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p id="loader-text" style="margin-top:10px; font-weight:bold;">Pobieranie danych...</p>
</div>

<div class="panel">
    <div id="path" style="font-size: 10px; color: #3498db; font-weight: bold;">POLSKA</div>
    <h2 id="region-name" style="margin: 5px 0; font-size: 20px;">Województwa</h2>
    <div class="price-tag"><span id="price-val">--</span> <span class="unit">PLN/m²</span></div>
    <div id="legend" class="legend"></div>
    <button id="back-btn">← WRÓĆ POZIOM WYŻEJ</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- AKTUALNE DANE CENOWE (ŚREDNIE 2024/2025) ---
    const wojPrices = {
        "02": 12800, "04": 8400, "06": 9200, "08": 8100, "10": 9600, "12": 16200, 
        "14": 17800, "16": 8300, "18": 8900, "20": 9400, "22": 13900, "24": 10500, 
        "26": 8200, "28": 8600, "30": 11500, "32": 11100
    };

    // Miasta na prawach powiatu (specjalne ceny dla TERC)
    const cityPrices = {
        "1465": 18500, // Warszawa
        "1261": 16800, // Kraków
        "0264": 13500, // Wrocław
        "2261": 15200, // Gdańsk
        "3064": 12800, // Poznań
        "1061": 9800,  // Łódź
        "2469": 10200, // Katowice
        "0661": 10500  // Lublin
    };

    const map = L.map('map').setView([52.0, 19.0], 6);
    let currentLayer, currentLevel = 'woj', history = [], cache = {};

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    function getPrice(terc) {
        if (cityPrices[terc]) return cityPrices[terc];
        const wojCode = terc.substring(0, 2);
        const base = wojPrices[wojCode] || 8000;
        
        // Symulacja zróżnicowania dla powiatów/gmin (powtarzalna losowość)
        let seed = parseInt(terc);
        let variation = (Math.abs(Math.sin(seed)) * 0.4) + 0.8; // 80% - 120% ceny bazowej
        return Math.floor(base * variation);
    }

    function getColor(d) {
        return d > 15000 ? '#800026' : d > 12000 ? '#BD0026' : d > 10000 ? '#E31A1C' :
               d > 8500  ? '#FC4E2A' : d > 7000  ? '#FD8D3C' : '#FEB24C';
    }

    async function loadData(level, filterTerc = '') {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        
        // Używamy jsDelivr CDN dla stabilności
        const url = `https://cdn.jsdelivr.net/gh/ppatrzyk/polska-geojson@master/${level === 'woj' ? 'wojewodztwa' : level === 'pow' ? 'powiaty' : 'gminy'}/${level === 'woj' ? 'wojewodztwa' : level === 'pow' ? 'powiaty' : 'gminy'}-low.geojson`;

        try {
            let data = cache[level] || await (await fetch(url)).json();
            cache[level] = data;

            if (currentLayer) map.removeLayer(currentLayer);

            currentLayer = L.geoJson(data, {
                filter: f => level === 'woj' ? true : f.properties.terc.startsWith(filterTerc),
                style: f => ({
                    fillColor: getColor(getPrice(f.properties.terc)),
                    weight: 1, color: 'white', fillOpacity: 0.7
                }),
                onEachFeature: (f, layer) => {
                    layer.on({
                        mouseover: e => {
                            const p = f.properties;
                            document.getElementById('region-name').innerText = p.nazwa;
                            document.getElementById('price-val').innerText = getPrice(p.terc).toLocaleString();
                            e.target.setStyle({ weight: 3, color: '#666', fillOpacity: 0.9 });
                        },
                        mouseout: e => currentLayer.resetStyle(e.target),
                        click: e => {
                            const p = f.properties;
                            if (level === 'woj') {
                                history.push({ level: 'woj', filter: '', path: 'POLSKA' });
                                currentLevel = 'pow';
                                document.getElementById('back-btn').style.display = 'block';
                                document.getElementById('path').innerText = "POLSKA > " + p.nazwa;
                                map.fitBounds(e.target.getBounds());
                                loadData('pow', p.terc);
                            } else if (level === 'pow') {
                                history.push({ level: 'pow', filter: p.terc.substring(0, 2), path: document.getElementById('path').innerText });
                                currentLevel = 'gmi';
                                document.getElementById('path').innerText += " > " + p.nazwa;
                                map.fitBounds(e.target.getBounds());
                                loadData('gmi', p.terc);
                            }
                        }
                    });
                }
            }).addTo(map);
        
        } finally {
            loader.style.display = 'none';
        }
    }

    document.getElementById('back-btn').onclick = () => {
        const prev = history.pop();
        if (!prev) return;
        currentLevel = prev.level;
        document.getElementById('path').innerText = prev.path;
        if (currentLevel === 'woj') {
            document.getElementById('back-btn').style.display = 'none';
            map.setView([52.0, 19.0], 6);
        }
        loadData(currentLevel, prev.filter);
    };

    const grades = [0, 7000, 8500, 10000, 12000, 15000];
    const legend = document.getElementById('legend');
    legend.innerHTML = '<strong>Cena (PLN/m²)</strong><br>';
    grades.forEach((g, i) => {
        legend.innerHTML += `<i style="background:${getColor(g + 1)}"></i> ${g}${grades[i+1] ? '&ndash;'+grades[i+1] : '+'}<br>`;
    });

    loadData('woj');
</script>
</body>
</html>
