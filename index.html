<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Nieruchomości Polska</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; background: #f4f4f4; }
        #map { height: 100vh; width: 100%; }
        
        .panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 240px;
        }

        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }

        .spinner {
            width: 40px; height: 40px; border: 4px solid #ddd;
            border-top: 4px solid #3498db; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        #back-btn { 
            display: none; width: 100%; margin-top: 10px; padding: 8px;
            background: #333; color: white; border: none; cursor: pointer; border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p id="loader-text">Pobieranie danych...</p>
</div>

<div class="panel">
    <div id="path" style="font-size: 10px; color: gray;">POLSKA</div>
    <h3 id="region-name" style="margin: 5px 0;">Województwa</h3>
    <div style="font-size: 20px; font-weight: bold; color: #e74c3c;" id="price-display">-- <span style="font-size: 12px; color: #666;">PLN/m²</span></div>
    <div id="legend" style="margin-top:10px; font-size: 12px; line-height: 18px;"></div>
    <button id="back-btn">← Wróć wyżej</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([52.0, 19.0], 6);
    let currentLayer;
    let currentLevel = 'woj';
    let cache = {};
    let history = [];

    // Używamy bezpośrednich linków do Raw GitHub z dodatkowym parametrem, aby uniknąć agresywnego cache'owania
    const BASE_URL = "https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/";
    const URLS = {
        woj: BASE_URL + "wojewodztwa/wojewodztwa-low.geojson",
        pow: BASE_URL + "powiaty/powiaty-low.geojson",
        gmi: BASE_URL + "gminy/gminy-low.geojson"
    };

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    function getPrice(terc) {
        if (!terc) return 5000;
        let s = parseInt(terc);
        return Math.floor(6000 + (Math.abs(Math.sin(s)) * 8000));
    }

    function getColor(d) {
        return d > 12000 ? '#800026' : d > 10000 ? '#BD0026' : d > 9000 ? '#E31A1C' :
               d > 8000 ? '#FC4E2A' : d > 7000 ? '#FD8D3C' : '#FEB24C';
    }

    async function loadLayer(level, filterTerc = '') {
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        loader.style.display = 'flex';
        loaderText.innerText = `Wczytywanie: ${level === 'gmi' ? 'Gminy (duży plik)' : level.toUpperCase()}`;

        try {
            let data;
            if (cache[level]) {
                data = cache[level];
            } else {
                console.log("Pobieranie z: " + URLS[level]);
                const response = await fetch(URLS[level]);
                if (!response.ok) throw new Error("Status: " + response.status);
                data = await response.json();
                cache[level] = data;
            }

            if (currentLayer) map.removeLayer(currentLayer);

            currentLayer = L.geoJson(data, {
                filter: f => level === 'woj' ? true : f.properties.terc.startsWith(filterTerc),
                style: f => ({
                    fillColor: getColor(getPrice(f.properties.terc)),
                    weight: 1, color: 'white', fillOpacity: 0.7
                }),
                onEachFeature: (f, layer) => {
                    layer.on({
                        mouseover: e => {
                            const p = f.properties;
                            document.getElementById('region-name').innerText = p.nazwa;
                            document.getElementById('price-display').innerHTML = getPrice(p.terc).toLocaleString() + ' <span style="font-size: 12px; color: #666;">PLN/m²</span>';
                            e.target.setStyle({ weight: 3, color: '#666', fillOpacity: 0.9 });
                        },
                        mouseout: e => currentLayer.resetStyle(e.target),
                        click: e => {
                            const p = f.properties;
                            if (level === 'woj') {
                                history.push({ level: 'woj', filter: '', path: 'POLSKA' });
                                currentLevel = 'pow';
                                document.getElementById('back-btn').style.display = 'block';
                                document.getElementById('path').innerText = "POLSKA > " + p.nazwa.toUpperCase();
                                map.fitBounds(e.target.getBounds());
                                loadLayer('pow', p.terc);
                            } else if (level === 'pow') {
                                history.push({ level: 'pow', filter: p.terc.substring(0, 2), path: document.getElementById('path').innerText });
                                currentLevel = 'gmi';
                                document.getElementById('path').innerText += " > " + p.nazwa.toUpperCase();
                                map.fitBounds(e.target.getBounds());
                                loadLayer('gmi', p.terc);
                            }
                        }
                    });
                }
            }).addTo(map);

        } catch (err) {
            console.error("BŁĄD:", err);
            alert("Błąd połączenia z danymi mapy. Sprawdź konsolę F12.");
        } finally {
            loader.style.display = 'none';
        }
    }

    document.getElementById('back-btn').onclick = () => {
        const prev = history.pop();
        if (!prev) return;
        currentLevel = prev.level;
        document.getElementById('path').innerText = prev.path;
        if (currentLevel === 'woj') {
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('region-name').innerText = "Województwa";
            map.setView([52.0, 19.0], 6);
        }
        loadLayer(currentLevel, prev.filter);
    };

    // Legenda
    const grades = [0, 7000, 8000, 9000, 10000, 12000];
    const legend = document.getElementById('legend');
    grades.forEach((g, i) => {
        legend.innerHTML += `<i style="background:${getColor(g + 1)}"></i> ${g}${grades[i+1] ? '&ndash;'+grades[i+1] : '+'}<br>`;
    });

    // Start
    loadLayer('woj');
</script>
</body>
</html>
